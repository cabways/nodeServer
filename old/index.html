<!DOCTYPE html>
<html>
<head>
    <title>WebSocket测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">WebSocket 测试工具</h1>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">服务器地址</label>
            <input type="text" id="serverUrl" value="ws://localhost:8080" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <button id="connectBtn" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                <i class="fa fa-plug mr-1"></i> 连接服务器
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">发送消息</label>
            <input type="text" id="messageInput" placeholder="输入要发送的消息..." 
                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <button id="sendBtn" class="mt-2 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" disabled>
                <i class="fa fa-paper-plane mr-1"></i> 发送消息
            </button>
        </div>
        
        <div>
            <label class="block text-gray-700 mb-2">消息记录</label>
            <div id="messageLog" class="border border-gray-300 rounded-md h-64 p-3 overflow-y-auto bg-gray-50 text-gray-800">
                <p class="text-gray-500 text-sm">等待连接...</p>
            </div>
        </div>
    </div>

    <script>
        let ws;
        const serverUrlInput = document.getElementById('serverUrl');
        const connectBtn = document.getElementById('connectBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messageLog = document.getElementById('messageLog');

        // 连接服务器
        connectBtn.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
                updateLog('已断开连接', 'red');
                connectBtn.innerHTML = '<i class="fa fa-plug mr-1"></i> 连接服务器';
                sendBtn.disabled = true;
                return;
            }

            const url = serverUrlInput.value;
            ws = new WebSocket(url);

            ws.onopen = () => {
                updateLog(`已连接到 ${url}`, 'green');
                connectBtn.innerHTML = '<i class="fa fa-unplug mr-1"></i> 断开连接';
                sendBtn.disabled = false;
            };

            // 修复：处理Blob类型消息
            ws.onmessage = async (event) => {
                let message;
                // 检查是否是Blob对象
                if (event.data instanceof Blob) {
                    // 将Blob转换为文本
                    message = await new Response(event.data).text();
                } else {
                    // 普通文本消息直接使用
                    message = event.data;
                }
                updateLog(`服务器: ${message}`, 'blue');
            };

            ws.onclose = () => {
                updateLog('连接已关闭', 'red');
                connectBtn.innerHTML = '<i class="fa fa-plug mr-1"></i> 连接服务器';
                sendBtn.disabled = true;
            };

            ws.onerror = (error) => {
                updateLog(`错误: ${error}`, 'red');
            };
        });

        // 发送消息
        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                updateLog(`客户端: ${message}`, 'gray');
                messageInput.value = '';
            }
        });

        // 按Enter发送消息
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBtn.click();
        });

        // 更新消息日志
        function updateLog(text, color) {
            const timestamp = new Date().toLocaleTimeString();
            const logItem = document.createElement('p');
            logItem.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span style="color: ${color}">${text}</span>`;
            messageLog.appendChild(logItem);
            messageLog.scrollTop = messageLog.scrollHeight; // 自动滚动到底部
        }
    </script>
</body>
</html>
